!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).VueApng=t()}(this,function(){"use strict";for(var e=function(){this.width=0,this.height=0,this.numPlays=0,this.playTime=0,this.frames=[],this.play=function(){r||i||(this.rewind(),r=!0,o())},this.rewind=function(){t=0,n=0,a=null,r=!1,i=!1},this.addContext=function(e){if(s.length>0){var t=s[0].getImageData(0,0,this.width,this.height);e.putImageData(t,0,0)}s.push(e),e._apng_animation=this},this.removeContext=function(e){var t=s.indexOf(e);-1!==t&&(s.splice(t,1),0===s.length&&this.rewind(),"_apng_animation"in e&&delete e._apng_animation)},this.isPlayed=function(){return r},this.isFinished=function(){return i};var e=this,t=0,n=0,a=null,r=!1,i=!1,s=[],o=function e(n){for(;r&&t<=n;)c(n);r&&requestAnimationFrame(e)},c=function(o){var c=n++%e.frames.length,u=e.frames[c];if(0===c&&(s.forEach(function(t){t.clearRect(0,0,e.width,e.height)}),a=null,2===u.disposeOp&&(u.disposeOp=1)),a&&1===a.disposeOp?s.forEach(function(e){e.clearRect(a.left,a.top,a.width,a.height)}):a&&2===a.disposeOp&&s.forEach(function(e){e.putImageData(a.iData,a.left,a.top)}),(a=u).iData=null,2===a.disposeOp&&(a.iData=s[0].getImageData(u.left,u.top,u.width,u.height)),0===u.blendOp&&s.forEach(function(e){e.clearRect(u.left,u.top,u.width,u.height)}),s.forEach(function(e){e.drawImage(u.img,u.left,u.top)}),0===e.numPlays||n/e.frames.length<e.numPlays){for(0===t&&(t=o);o>t+e.playTime;)t+=e.playTime;t+=u.delay}else r=!1,i=!1}},t=new Uint32Array(256),n=0;n<256;n++){for(var a=n,r=0;r<8;r++)a=1&a?3988292384^a>>>1:a>>>1;t[n]=a}var i=new Uint8Array([137,80,78,71,13,10,26,10]),s=function(t){var n=new Uint8Array(t);return new Promise(function(t,a){for(var r=0;r<i.length;r++)if(i[r]!==n[r])return void a(new Error("Not a PNG file (invalid file signature)"));var s=!1,p=!1;if(u(n,function(e){return"acTL"===e?(s=!0,!1):"acTV"!==e||(s=!0,p=!0,!1)}),s){var A=[],v=[],y=null,w=null,b=new e,E=!1;if(u(n,function(e,t,n,a){switch(e){case"IHDR":y=t.subarray(n+8,n+8+a),b.width=l(t,n+8),b.height=l(t,n+12);break;case"acTL":case"acTV":b.numPlays=l(t,n+8+4);break;case"fcTL":case"fcTV":w&&b.frames.push(w),(w={}).isAJPNG=p,w.isDefault=!E,w.width=l(t,n+8+4),w.height=l(t,n+8+8),w.left=l(t,n+8+12),w.top=l(t,n+8+16);var r=d(t,n+8+20),i=d(t,n+8+22);0===i&&(i=100),w.delay=1e3*r/i,w.delay<=10&&(w.delay=100),b.playTime+=w.delay,w.disposeOp=f(t,n+8+24),w.blendOp=f(t,n+8+25),w.dataParts=[];break;case"fdAT":w&&w.dataParts.push(t.subarray(n+8+4,n+8+a));break;case"fdAV":if(w){var s=l(t,n+8+4);0===s?w.dataParts.push({jpeg:t.subarray(n+8+8,n+8+a)}):w.dataParts.push({jpeg:t.subarray(n+8+8,n+8+8+s),alpha:t.subarray(n+8+8+s,n+8+a)})}break;case"IDAT":w&&w.dataParts.push(t.subarray(n+8,n+8+a)),E=!0;break;case"IEND":v.push(h(t,n,12+a));break;default:A.push(h(t,n,12+a))}}),w&&b.frames.push(w),0!==b.frames.length)for(var R=0,_=new Blob(A),T=new Blob(v),C=function(e){w=b.frames[e];var n,r=void 0,s=void 0;if(w.isAJPNG&&!w.isDefault){for(r=0;r<w.dataParts.length;r++)if((P=w.dataParts[r])&&P.jpeg){B=URL.createObjectURL(new Blob([P.jpeg],{type:"image/jpeg"})),P.alpha?(n=void 0,n=URL.createObjectURL(new Blob([P.alpha],{type:"image/png"})),function(e){o(B,n,function(n,r){r?(e.img=r,++R===b.frames.length&&t(b)):a(n)})}(w),s=null):s=B;break}}else{for((U=[]).push(i),y.set(g(w.width),0),y.set(g(w.height),4),U.push(m("IHDR",y)),U.push(_),r=0;r<w.dataParts.length;r++)U.push(m("IDAT",w.dataParts[r]));U.push(T),s=URL.createObjectURL(new Blob(U,{type:"image/png"})),U=null}delete w.dataParts,s&&function(e){c(s,function(n,r){r?(e.img=r,++R===b.frames.length&&t(b)):a(n)})}(w)},I=0;I<b.frames.length;I++){var P,B,U;C(I)}else a("Not an animated PNG")}else a("Not an animated PNG")})},o=function(e,t,n){c(e,function(e,a){a?c(t,function(e,t){if(t){var r=document.createElement("canvas"),i=r.width=t.naturalWidth,s=r.height=t.naturalHeight,o=r.getContext("2d");o.drawImage(a,0,0);var c=o.getImageData(0,0,i,s),u=c.data;o.clearRect(0,0,i,s),o.drawImage(t,0,0);for(var l=o.getImageData(0,0,i,s).data,d=u.length-1;d>0;d-=4){var f=l[d],h=255/f;u[d]=f,u[d-1]*=h,u[d-2]*=h,u[d-3]*=h}o.putImageData(c,0,0),n(null,r)}else n(e)}):n(e)})},c=function(e,t){var n=document.createElement("img");n.onload=function(){URL.revokeObjectURL(this.src),t(null,this)},n.onerror=function(){console.error("Image creation error")},n.src=e},u=function(e,t){var n,a,r,i=8;do{n=l(e,i),r=t(a=p(e,i+4,4),e,i,n),i+=12+n}while(!1!==r&&"IEND"!==a&&i<e.length)},l=function(e,t){var n=0;n+=e[0+t]<<24>>>0;for(var a=1;a<4;a++)n+=e[a+t]<<8*(3-a);return n},d=function(e,t){for(var n=0,a=0;a<2;a++)n+=e[a+t]<<8*(1-a);return n},f=function(e,t){return e[t]},h=function(e,t,n){var a=new Uint8Array(n);return a.set(e.subarray(t,t+n)),a},p=function(e,t,n){var a=Array.prototype.slice.call(e.subarray(t,t+n));return String.fromCharCode.apply(String,a)},g=function(e){return[e>>>24&255,e>>>16&255,e>>>8&255,255&e]},m=function(e,n){var a=e.length+n.length,r=new Uint8Array(new ArrayBuffer(a+8));r.set(g(n.length),0),r.set(function(e){for(var t=[],n=0;n<e.length;n++)t.push(e.charCodeAt(n));return t}(e),4),r.set(n,8);var i=function(e,n,a){for(var r=-1,i=n=n||0,s=n+(a=a||e.length-n);i<s;i++)r=r>>>8^t[255&(r^e[i])];return-1^r}(r,4,a);return r.set(g(i),a+4),r},A={name:"v-apng",props:{src:[String,HTMLImageElement],ignore:Boolean},data:function(){return{supported:!0}},computed:{imgSrc:function(e){var t=e.src;return t instanceof HTMLImageElement?t.src:t}},watch:{supported:{immediate:!0,handler:function(e){var t=this;e||this.$nextTick(function(e){if(t.canvas=t.$refs.c,t.canvas){t.ctx=t.canvas.getContext("2d");var n,a=t.canvas,r=t.$el;a.style.width=r.clientWidth+"px",a.style.height=r.clientHeight+"px",(n=t.imgSrc,new Promise(function(e,t){var a,r;a=n,(r=new XMLHttpRequest).open("GET",a),r.responseType="arraybuffer",r.onload=function(){200===this.status?e(this.response):t(new Error("request ArrayBuffer fail"))},r.send()})).then(s).then(function(e){a.width=e.width,a.height=e.height,e.addContext(t.ctx),e.play()})}})}}},created:function(){var e=this;this.ignore?this.supported=!1:new Promise(function(e,t){var n=document.createElement("canvas"),a=new Image;a.onload=function(){var t=n.getContext("2d");t.drawImage(a,0,0);var r=0===t.getImageData(0,0,1,1).data[3];e(r)},a.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACGFjVEwAAAABAAAAAcMq2TYAAAANSURBVAiZY2BgYPgPAAEEAQB9ssjfAAAAGmZjVEwAAAAAAAAAAQAAAAEAAAAAAAAAAAD6A+gBAbNU+2sAAAARZmRBVAAAAAEImWNgYGBgAAAABQAB6MzFdgAAAABJRU5ErkJggg=="}).then(function(t){e.supported=t})}};var v,y=function(e,t,n,a,r,i,s,o,c,u){"boolean"!=typeof s&&(c=o,o=s,s=!1);var l,d="function"==typeof n?n.options:n;if(e&&e.render&&(d.render=e.render,d.staticRenderFns=e.staticRenderFns,d._compiled=!0,r&&(d.functional=!0)),a&&(d._scopeId=a),i?(l=function(e){(e=e||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(e=__VUE_SSR_CONTEXT__),t&&t.call(this,c(e)),e&&e._registeredComponents&&e._registeredComponents.add(i)},d._ssrRegister=l):t&&(l=s?function(){t.call(this,u(this.$root.$options.shadowRoot))}:function(e){t.call(this,o(e))}),l)if(d.functional){var f=d.render;d.render=function(e,t){return l.call(t),f(e,t)}}else{var h=d.beforeCreate;d.beforeCreate=h?[].concat(h,l):[l]}return n},w="undefined"!=typeof navigator&&/msie [6-9]\\b/.test(navigator.userAgent.toLowerCase());var b={};var E=y({render:function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"apng-wrapper"},[this.imgSrc?[this.supported?t("img",{attrs:{src:this.imgSrc}}):t("canvas",{ref:"c"})]:this._e(),this._v(" "),this._t("default")],2)},staticRenderFns:[]},function(e){e&&e("data-v-5ad13412_0",{source:".apng-wrapper{position:relative}.apng-wrapper canvas,.apng-wrapper img{width:100%;height:100%}.apng-wrapper canvas,.apng-wrapper img{position:absolute;left:0;top:0}",map:void 0,media:void 0})},A,void 0,!1,void 0,function(e){return function(e,t){return function(e,t){var n=w?t.media||"default":e,a=b[n]||(b[n]={ids:new Set,styles:[]});if(!a.ids.has(e)){a.ids.add(e);var r=t.source;if(t.map&&(r+="\n/*# sourceURL="+t.map.sources[0]+" */",r+="\n/*# sourceMappingURL=data:application/json;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(t.map))))+" */"),a.element||(a.element=document.createElement("style"),a.element.type="text/css",t.media&&a.element.setAttribute("media",t.media),void 0===v&&(v=document.head||document.getElementsByTagName("head")[0]),v.appendChild(a.element)),"styleSheet"in a.element)a.styles.push(r),a.element.styleSheet.cssText=a.styles.filter(Boolean).join("\n");else{var i=a.ids.size-1,s=document.createTextNode(r),o=a.element.childNodes;o[i]&&a.element.removeChild(o[i]),o.length?a.element.insertBefore(s,o[i]):a.element.appendChild(s)}}}(e,t)}},void 0);return E.install=function e(t){e.installed||(e.installed=!0,Vue.component("v-apng",E))},E});
