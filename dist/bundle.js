var e=e=>new Promise(function(t,n){var a,r;a=e,(r=new XMLHttpRequest).open("GET",a),r.responseType="arraybuffer",r.onload=function(){200===this.status?t(this.response):n(new Error("request ArrayBuffer fail"))},r.send()});const t=function(){this.width=0,this.height=0,this.numPlays=0,this.playTime=0,this.frames=[],this.play=function(){r||i||(this.rewind(),r=!0,o())},this.rewind=function(){t=0,n=0,a=null,r=!1,i=!1},this.addContext=function(e){if(s.length>0){var t=s[0].getImageData(0,0,this.width,this.height);e.putImageData(t,0,0)}s.push(e),e._apng_animation=this},this.removeContext=function(e){var t=s.indexOf(e);-1!==t&&(s.splice(t,1),0===s.length&&this.rewind(),"_apng_animation"in e&&delete e._apng_animation)},this.isPlayed=function(){return r},this.isFinished=function(){return i};let e=this,t=0,n=0,a=null,r=!1,i=!1,s=[],o=function(e){for(;r&&t<=e;)l(e);r&&requestAnimationFrame(o)},l=function(o){let l=n++%e.frames.length,c=e.frames[l];if(0===l&&(s.forEach(function(t){t.clearRect(0,0,e.width,e.height)}),a=null,2===c.disposeOp&&(c.disposeOp=1)),a&&1===a.disposeOp?s.forEach(function(e){e.clearRect(a.left,a.top,a.width,a.height)}):a&&2===a.disposeOp&&s.forEach(function(e){e.putImageData(a.iData,a.left,a.top)}),(a=c).iData=null,2===a.disposeOp&&(a.iData=s[0].getImageData(c.left,c.top,c.width,c.height)),0===c.blendOp&&s.forEach(function(e){e.clearRect(c.left,c.top,c.width,c.height)}),s.forEach(function(e){e.drawImage(c.img,c.left,c.top)}),0===e.numPlays||n/e.frames.length<e.numPlays){for(0===t&&(t=o);o>t+e.playTime;)t+=e.playTime;t+=c.delay}else r=!1,i=!1}},n=new Uint32Array(256);for(let e=0;e<256;e++){let t=e;for(let e=0;e<8;e++)t=1&t?3988292384^t>>>1:t>>>1;n[e]=t}const a=new Uint8Array([137,80,78,71,13,10,26,10]),r=e=>{const n=new Uint8Array(e);return new Promise((e,r)=>{for(let e=0;e<a.length;e++)if(a[e]!==n[e])return void r(new Error("Not a PNG file (invalid file signature)"));let u=!1,f=!1;if(o(n,e=>"acTL"===e?(u=!0,!1):"acTV"!==e||(u=!0,f=!0,!1)),!u)return void r("Not an animated PNG");let A=[],m=[],v=null,w=null,y=new t,E=!1;if(o(n,function(e,t,n,a){switch(e){case"IHDR":v=t.subarray(n+8,n+8+a),y.width=l(t,n+8),y.height=l(t,n+12);break;case"acTL":case"acTV":y.numPlays=l(t,n+8+4);break;case"fcTL":case"fcTV":w&&y.frames.push(w),(w={}).isAJPNG=f,w.isDefault=!E,w.width=l(t,n+8+4),w.height=l(t,n+8+8),w.left=l(t,n+8+12),w.top=l(t,n+8+16);let r=c(t,n+8+20),i=c(t,n+8+22);0===i&&(i=100),w.delay=1e3*r/i,w.delay<=10&&(w.delay=100),y.playTime+=w.delay,w.disposeOp=p(t,n+8+24),w.blendOp=p(t,n+8+25),w.dataParts=[];break;case"fdAT":w&&w.dataParts.push(t.subarray(n+8+4,n+8+a));break;case"fdAV":if(w){let e=l(t,n+8+4);0===e?w.dataParts.push({jpeg:t.subarray(n+8+8,n+8+a)}):w.dataParts.push({jpeg:t.subarray(n+8+8,n+8+8+e),alpha:t.subarray(n+8+8+e,n+8+a)})}break;case"IDAT":w&&w.dataParts.push(t.subarray(n+8,n+8+a)),E=!0;break;case"IEND":m.push(h(t,n,12+a));break;default:A.push(h(t,n,12+a))}}),w&&y.frames.push(w),0===y.frames.length)return void r("Not an animated PNG");let b=0,C=new Blob(A),R=new Blob(m);for(let t=0;t<y.frames.length;t++){let n,o;if((w=y.frames[t]).isAJPNG&&!w.isDefault)for(n=0;n<w.dataParts.length;n++){var _=w.dataParts[n];if(_&&_.jpeg){var T=URL.createObjectURL(new Blob([_.jpeg],{type:"image/jpeg"}));if(_.alpha){let t=URL.createObjectURL(new Blob([_.alpha],{type:"image/png"}));!function(n){i(T,t,function(t,a){a?(n.img=a,++b===y.frames.length&&e(y)):r(t)})}(w),o=null}else o=T;break}}else{var P=[];for(P.push(a),v.set(d(w.width),0),v.set(d(w.height),4),P.push(g("IHDR",v)),P.push(C),n=0;n<w.dataParts.length;n++)P.push(g("IDAT",w.dataParts[n]));P.push(R),o=URL.createObjectURL(new Blob(P,{type:"image/png"})),P=null}delete w.dataParts,o&&function(t){s(o,function(n,a){a?(t.img=a,++b===y.frames.length&&e(y)):r(n)})}(w)}})},i=function(e,t,n){s(e,function(e,a){a?s(t,function(e,t){if(t){let e=document.createElement("canvas"),r=e.width=t.naturalWidth,i=e.height=t.naturalHeight,s=e.getContext("2d");s.drawImage(a,0,0);let o=s.getImageData(0,0,r,i),l=o.data;s.clearRect(0,0,r,i),s.drawImage(t,0,0);let c=s.getImageData(0,0,r,i).data;for(let e=l.length-1;e>0;e-=4){let t=c[e],n=255/t;l[e]=t,l[e-1]*=n,l[e-2]*=n,l[e-3]*=n}s.putImageData(o,0,0),n(null,e)}else n(e)}):n(e)})},s=function(e,t){const n=document.createElement("img");n.onload=function(){URL.revokeObjectURL(this.src),t(null,this)},n.onerror=function(){console.error("Image creation error")},n.src=e},o=function(e,t){let n,a,r,i=8;do{n=l(e,i),r=t(a=u(e,i+4,4),e,i,n),i+=12+n}while(!1!==r&&"IEND"!==a&&i<e.length)},l=function(e,t){let n=0;n+=e[0+t]<<24>>>0;for(let a=1;a<4;a++)n+=e[a+t]<<8*(3-a);return n},c=function(e,t){let n=0;for(let a=0;a<2;a++)n+=e[a+t]<<8*(1-a);return n},p=function(e,t){return e[t]},h=function(e,t,n){let a=new Uint8Array(n);return a.set(e.subarray(t,t+n)),a},u=function(e,t,n){let a=Array.prototype.slice.call(e.subarray(t,t+n));return String.fromCharCode.apply(String,a)},d=function(e){return[e>>>24&255,e>>>16&255,e>>>8&255,255&e]},g=function(e,t){let a=e.length+t.length,r=new Uint8Array(new ArrayBuffer(a+8));r.set(d(t.length),0),r.set(function(e){let t=[];for(let n=0;n<e.length;n++)t.push(e.charCodeAt(n));return t}(e),4),r.set(t,8);let i=function(e,t,a){let r=-1;for(var i=t=t||0,s=t+(a=a||e.length-t);i<s;i++)r=r>>>8^n[255&(r^e[i])];return-1^r}(r,4,a);return r.set(d(i),a+4),r};var f={name:"v-apng",props:{src:[String,HTMLImageElement],ignore:Boolean,width:{type:String,required:!0},height:{type:String,default:"auto"}},data:()=>({supported:!0}),computed:{imgSrc:({src:e})=>e instanceof HTMLImageElement?e.src:e},watch:{supported:{immediate:!0,handler(t){t||this.$nextTick(t=>{if(this.canvas=this.$refs.c,!this.canvas)return;this.ctx=this.canvas.getContext("2d");const{canvas:n,$el:a}=this;n.style.width=a.clientWidth+"px",n.style.height=a.clientHeight+"px",e(this.imgSrc).then(r).then(e=>{n.width=e.width,n.height=e.height,e.addContext(this.ctx),e.play()})})}}},created(){this.ignore?this.supported=!1:(()=>new Promise((e,t)=>{const n=document.createElement("canvas"),a=new Image;a.onload=function(){const t=n.getContext("2d");t.drawImage(a,0,0);const r=0===t.getImageData(0,0,1,1).data[3];e(r)},a.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACGFjVEwAAAABAAAAAcMq2TYAAAANSURBVAiZY2BgYPgPAAEEAQB9ssjfAAAAGmZjVEwAAAAAAAAAAQAAAAEAAAAAAAAAAAD6A+gBAbNU+2sAAAARZmRBVAAAAAEImWNgYGBgAAAABQAB6MzFdgAAAABJRU5ErkJggg=="}))().then(e=>{this.supported=e})}};var A,m=function(e,t,n,a,r,i,s,o,l,c){"boolean"!=typeof s&&(l=o,o=s,s=!1);var p,h="function"==typeof n?n.options:n;if(e&&e.render&&(h.render=e.render,h.staticRenderFns=e.staticRenderFns,h._compiled=!0,r&&(h.functional=!0)),a&&(h._scopeId=a),i?(p=function(e){(e=e||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(e=__VUE_SSR_CONTEXT__),t&&t.call(this,l(e)),e&&e._registeredComponents&&e._registeredComponents.add(i)},h._ssrRegister=p):t&&(p=s?function(){t.call(this,c(this.$root.$options.shadowRoot))}:function(e){t.call(this,o(e))}),p)if(h.functional){var u=h.render;h.render=function(e,t){return p.call(t),u(e,t)}}else{var d=h.beforeCreate;h.beforeCreate=d?[].concat(d,p):[p]}return n},v="undefined"!=typeof navigator&&/msie [6-9]\\b/.test(navigator.userAgent.toLowerCase());var w={};var y=function(e){return function(e,t){return function(e,t){var n=v?t.media||"default":e,a=w[n]||(w[n]={ids:new Set,styles:[]});if(!a.ids.has(e)){a.ids.add(e);var r=t.source;if(t.map&&(r+="\n/*# sourceURL="+t.map.sources[0]+" */",r+="\n/*# sourceMappingURL=data:application/json;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(t.map))))+" */"),a.element||(a.element=document.createElement("style"),a.element.type="text/css",t.media&&a.element.setAttribute("media",t.media),void 0===A&&(A=document.head||document.getElementsByTagName("head")[0]),A.appendChild(a.element)),"styleSheet"in a.element)a.styles.push(r),a.element.styleSheet.cssText=a.styles.filter(Boolean).join("\n");else{var i=a.ids.size-1,s=document.createTextNode(r),o=a.element.childNodes;o[i]&&a.element.removeChild(o[i]),o.length?a.element.insertBefore(s,o[i]):a.element.appendChild(s)}}}(e,t)}};const E=f;var b=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"apng-wrapper",style:{width:e.width,height:e.height}},[e.imgSrc?[e.supported?n("img",{attrs:{src:e.imgSrc}}):n("canvas",{ref:"c"})]:e._e(),e._v(" "),e._t("default")],2)};b._withStripped=!0;var C=m({render:b,staticRenderFns:[]},function(e){e&&e("data-v-6419a0e0_0",{source:".apng-wrapper {\n  position: relative;\n}\n.apng-wrapper img,\n.apng-wrapper canvas {\n  width: 100%;\n  height: 100%;\n}\n.apng-wrapper img,\n.apng-wrapper canvas {\n  position: absolute;\n  left: 0;\n  top: 0;\n}\n\n/*# sourceMappingURL=apng.vue.map */",map:{version:3,sources:["/Users/zhangcheng/Public/source-code/vue-apng/src/apng.vue","apng.vue"],names:[],mappings:"AAuFA;EACA,kBAAA;ACtFA;ADuFA;;EAEA,WAAA;EACA,YAAA;ACrFA;ADwFA;;EAEA,kBAAA;EACA,OAAA;EACA,MAAA;ACtFA;;AAEA,mCAAmC",file:"apng.vue",sourcesContent:["<template>\n  <div class=\"apng-wrapper\"\n    :style=\"{ width, height }\">\n    <template v-if=\"imgSrc\">\n      <img :src=\"imgSrc\" v-if=\"supported\">\n      <canvas ref='c' v-else></canvas>\n    </template>\n    <slot></slot>\n  </div>\n</template>\n\n<script>\nimport supportAPNG from './utils/support_test.js'\nimport loadUrl from './utils/loader.js'\nimport parser from './utils/parser.js'\n\nexport default {\n  name: 'v-apng',\n  props: {\n    src: [String, HTMLImageElement],\n    ignore: Boolean,\n    width: {\n      type: String,\n      required: true\n    },\n    height: {\n      type: String,\n      default: 'auto'\n    }\n  },\n\n  data () {\n    return {\n      supported: true\n    }\n  },\n\n  computed: {\n    imgSrc ({ src }) {\n      if (src instanceof HTMLImageElement) {\n        return src.src\n      }\n      return src\n    }\n  },\n\n  watch: {\n    supported: {\n      immediate: true,\n      handler (val) {\n        if (val) return\n        this.$nextTick(_ => {\n          this.canvas = this.$refs.c\n          if (!this.canvas) return\n\n          this.ctx = this.canvas.getContext('2d')\n          const { canvas, $el } = this\n          canvas.style.width = $el.clientWidth + 'px'\n          canvas.style.height = $el.clientHeight + 'px'\n\n          loadUrl(this.imgSrc)\n            .then(parser)\n            .then(anim => {\n              canvas.width = anim.width\n              canvas.height = anim.height\n              anim.addContext(this.ctx)\n              anim.play()\n            })\n        })\n      }\n    }\n  },\n\n  created () {\n    if (this.ignore) {\n      this.supported = false\n      return\n    }\n\n    supportAPNG().then(r => {\n      this.supported = r\n    })\n  }\n}\n<\/script>\n\n<style lang=\"scss\">\n.apng-wrapper {\n  position: relative;\n  img,\n  canvas {\n    width: 100%;\n    height: 100%;\n  }\n\n  img,\n  canvas {\n    position: absolute;\n    left: 0;\n    top: 0;\n  }\n}\n</style>\n",".apng-wrapper {\n  position: relative;\n}\n.apng-wrapper img,\n.apng-wrapper canvas {\n  width: 100%;\n  height: 100%;\n}\n.apng-wrapper img,\n.apng-wrapper canvas {\n  position: absolute;\n  left: 0;\n  top: 0;\n}\n\n/*# sourceMappingURL=apng.vue.map */"]},media:void 0})},E,void 0,!1,void 0,y,void 0);C.install=function e(t){e.installed||(e.installed=!0,Vue.component("v-apng",C))};export default C;
